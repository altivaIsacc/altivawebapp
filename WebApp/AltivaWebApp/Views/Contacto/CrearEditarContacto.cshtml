@model AltivaWebApp.ViewModels.ContactoViewModel
@inject IStringLocalizer<SharedResources> Lb
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@functions{
    public string GetAntiXsrfRequestToken()
    {
        return Xsrf.GetAndStoreTokens(Context).RequestToken;
    }
}
@{

    var tipoEmpresa = "";
    var tipoPersona = "";
    var tipoCliente = "";
    var tipoProveedor = "";

    if (Model.Persona)
    {
        tipoEmpresa = "hidden";
    }
    else
    {
        tipoPersona = "hidden";
    }

    if (!Model.Cliente)
    {
        tipoCliente = "hidden";
    }

    if (!Model.Proveedor)
    {
        tipoProveedor = "hidden";
    }

}


<div class="row">
    @if (Model.IdContacto != 0)
    {
        <div class="col-md-12 col-sm-12 col-xs-12">
            <h3> @Lb["Editar"] @Lb["Contacto"]</h3>
        </div>
    }
    else
    {
        <div class="col-md-12 col-sm-12 col-xs-12">
            <h3> @Lb["Nuevo"] @Lb["Contacto"]</h3>
        </div>
    }
</div>


<div class="row well">

    <form id="frmContacto">
        @Html.HiddenFor(x => x.IdContacto)
        @Html.HiddenFor(x => x.Ruta)

        <div class="form-group col-md-12 col-sm-12 col-xs-12">
            <label class="radio-inline" for="persona"><input type="radio" name="radioTipo" onchange="ocultarCamposNombre(1)" checked="@Model.Persona" id="persona" />@Lb["Persona"]</label>
            <label class="radio-inline" for="empresa"><input type="radio" name="radioTipo" onchange="ocultarCamposNombre(2)" checked="@Model.Empresa" id="empresa" />@Lb["Empresa"]</label>
        </div>

        <div @tipoPersona class="form-group col-md-4 col-sm-4 col-xs-12 nombrePersona">
            <label asp-for="Nombre" class="control-label">@Lb["Nombre"]:</label>
            <input asp-for="Nombre" autofocus maxlength="50" class="form-control" />
            <span hidden id="nombre" class="text-danger">@Lb["nombreValid"]</span>
        </div>
        <div @tipoPersona class="form-group col-md-4 col-sm-4 col-xs-12 nombrePersona">
            <label asp-for="Apellidos" class="control-label">@Lb["Apellidos"]:</label>
            <input asp-for="Apellidos" maxlength="75" class="form-control" />
            <span hidden id="apellidosValid" class="text-danger">@Lb["apellidosValid"]</span>
        </div>
        <div @tipoEmpresa class="form-group col-md-4 col-sm-4 col-xs-12 nombreEmpresa">
            <label asp-for="NombreComercial" class="control-label">@Lb["NombreComercial"]:</label>
            <input asp-for="NombreComercial" maxlength="90" class="form-control" />
            <span hidden id="nombreComercialValid" class="text-danger">@Lb["nombreValid"]</span>
        </div>
        <div @tipoEmpresa class="form-group col-md-4 col-sm-4 col-xs-12 nombreEmpresa">
            <label asp-for="NombreJuridico" class="control-label">@Lb["NombreJuridico"]:</label>
            <input asp-for="NombreJuridico" class="form-control" />
            <span hidden id="nombreJuridicaValid" class="text-danger">@Lb["nombreValid"]</span>
        </div>

        <div class="form-group col-md-2 col-sm-4 col-xs-12">
            <label asp-for="TipoCedula" class="control-label">@Lb["TipoCedula"]:</label>
            <select asp-for="TipoCedula" onchange="tipoCedula(value)" class="form-control">
                <option value="1">@Lb["Física"]</option>
                <option value="2">@Lb["Jurídica"]</option>
                <option value="3">@Lb["Dimex"]</option>
                <option value="4">@Lb["NITE"]</option>
            </select>
        </div>

        <div class="form-group col-md-2 col-sm-4 col-xs-12">
            <label asp-for="Cedula" class="control-label">@Lb["Cédula"]:</label>
            <input asp-for="Cedula" class="form-control" />
            <span hidden id="cedulaValid" class="text-danger">@Lb["cedulaValid"]</span>
        </div>

        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label asp-for="Telefono" class="control-label">@Lb["Teléfono"]:</label>
            <input asp-for="Telefono" type="text" class="form-control" />
            <span hidden id="telefonoValid" class="text-danger">@Lb["telefonoValid"]</span>
        </div>
        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label asp-for="Correo" class="control-label">@Lb["Correo"]:</label>
            <input asp-for="Correo" class="form-control" />
            <span hidden id="correoValid" class="text-danger">@Lb["correoValid"]</span>
        </div>




        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label asp-for="IdUsuario" class="control-label">@Lb["UsuarioEncargado"]:</label>

            <select asp-for="IdUsuario" class="form-control">
                @foreach (var item in ViewData["usuarios"] as IList<TbSeUsuario>)
                {
                    <option value="@item.Id">@item.Nombre</option>
                }
            </select>
        </div>

        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label class="input-group-text" id="inputGroup-sizing-sm">@Lb["CargarImagen"] (6MB)</label>
            <input type="file" accept="image/*" id="fileUpload" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
            <span hidden id="tamanoArchivo" class="text-danger">@Lb["tamanoArchivo"]</span>
            <span hidden id="tipoArchivo" class="text-danger">@Lb["tipoArchivo"]</span>
        </div>

        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label asp-for="WebLink" class="control-label">@Lb["PaginaWeb"]:</label>
            <input asp-for="WebLink" maxlength="150" class="form-control" />
        </div>


        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label asp-for="MapLink" class="control-label">@Lb["LinkUbicacion"]:</label>
            <input asp-for="MapLink" maxlength="500" class="form-control" />
        </div>



        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label asp-for="Pais" class="control-label">@Lb["País"]:</label>
            <select onchange="getProvincias()" asp-for="Pais" class="form-control">
                @foreach (var item in ViewData["paises"] as IList<TbSePais>)
                {
                    <option value="@item.Id">@item.NombreEs</option>
                }
            </select>
        </div>
        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label asp-for="Provincia" class="control-label">@Lb["Provincia"]:</label>
            <select onchange="getCantones(value)" class="form-control" asp-for="Provincia"></select>
        </div>
        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label asp-for="Canton" class="control-label">@Lb["Cantón"]:</label>
            <select onchange="getDistritos(value)" class="form-control" asp-for="Canton"></select>
        </div>

        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label asp-for="Distrito" class="control-label">@Lb["Distrito"]:</label>
            <select class="form-control" asp-for="Distrito"></select>
        </div>
        <div class="form-group col-md-8 col-sm-8 col-xs-12">
            <label asp-for="OtrasSenas" class="control-label">@Lb["OtrasSenas"]:</label>
            <textarea asp-for="OtrasSenas" maxlength="450" rows="4" class="form-control">@Model.OtrasSenas</textarea>
            <span hidden id="otrasSenasValid" class="text-danger">@Lb["otrasSenasValid"]</span>
        </div>

        <div class="form-group col-md-12 col-sm-12 col-xs-6">
            <label asp-for="Cliente" class="control-label">@Lb["Cliente"]</label>
            <input type="checkbox" onchange="mostrarTipoCliente()" asp-for="Cliente" />
        </div>

        <div @tipoCliente class="form-group col-md-4 col-sm-3 col-xs-12 tipoCliente">
            <label asp-for="IdTipoCliente" class="control-label">@Lb["TipoCliente"]:</label>
            <select asp-for="IdTipoCliente" class="form-control"></select>
        </div>

        <div @tipoCliente class="form-group col-md-4 col-sm-3 col-xs-12 tipoCliente">
            <label asp-for="IdFamiliaCliente" class="control-label">@Lb["FamiliaCliente"]:</label>
            <select asp-for="IdFamiliaCliente" class="form-control"></select>
        </div>
        <div @tipoCliente class="form-group col-md-4 col-sm-3 col-xs-12 tipoCliente">
            <label asp-for="IdSubFamiliaCliente" class="control-label">@Lb["SubFamiliaCliente"]:</label>
            <select asp-for="IdSubFamiliaCliente" class="form-control"></select>
        </div>



        <div class="form-group col-md-12 col-sm-12 col-xs-12">
            <label asp-for="Proveedor" class="control-label">@Lb["Proveedor"]</label>
            <input type="checkbox" onchange="mostrarTipoProveedor()" asp-for="Proveedor" />
        </div>

        <div @tipoProveedor class="form-group col-md-4 col-sm-4 col-xs-12 tipoProveedor">
            <label asp-for="IdTipoProveedor" class="control-label">@Lb["TipoProveedor"]:</label>
            <select asp-for="IdTipoProveedor" class="form-control"></select>
        </div>
        <div @tipoProveedor class="form-group col-md-4 col-sm-4 col-xs-12 tipoProveedor">
            <label asp-for="IdFamiliaProveedor" class="control-label">@Lb["FamiliaProveedor"]:</label>
            <select asp-for="IdFamiliaProveedor" class="form-control"></select>
        </div>
        <div @tipoProveedor class="form-group col-md-4 col-sm-4 col-xs-12 tipoProveedor">
            <label asp-for="IdSubFamiliaProveedor" class="control-label">@Lb["SubFamiliaProveedor"]:</label>
            <select asp-for="IdSubFamiliaProveedor" class="form-control"></select>
        </div>

    </form>

    <hr />

    <div class="form-group col-md-12 col-sm-12 col-xs-12">
        <div class="col-md-3 col-sm-3 col-xs-8">
            <h4>@Lb["CamposPersonalizados"]</h4>
        </div>
        <div class="col-md-3 col-sm-3 col-xs-4">
            <a class="btn btn-link" data-toggle="collapse" data-target="#collapseFrmCP" aria-expanded="false" aria-controls="collapseFrmCP"><span id="optFrmCP">@Lb["VerMas"]...</span></a>
        </div>
    </div>

    <div class="collapse" id="collapseFrmCP">
        <div class="card card-body ">
            <form id="frmCP" ></form>
        </div>
    </div>

</div>

<div class="row">
    <div class="form-group col-md-3">
        <button class="btn btn-success btnAccion" onclick="guardarCambios()">@Lb["Guardar"] <i class="fas fa-save"></i></button>
        <a onclick="cancelar()" class="btn btn-default">@Lb["Cancelar"]</a>
    </div>
</div>

<script>
    var camposPersonalizados = [];
    var ccPersonalizados = [];
    var paises = [];
    var $cedula = $('#Cedula');

    $(document).ready(function () {

        $('.cedFisica').mask('0-0000-0000');
        $('.cedJuridica').mask('0-000-000000');
        $('.cedDimex').mask('000000000000');
        $('.cedNite').mask('000000000000');

        tipoCedula("@Model.TipoCedula");

        getCamposPersonalizados();

        getProvincias();


    });


    //////////////////////////////////////helpers/////////////////////////////

    function guardarCambios() {

        var frmContacto = $('#frmContacto').serializeArray();
       
        console.log(frmContacto);
        console.log(ccPersonalizados);
    }

    function editarCCPersonalizado(value, key) {

        ccPersonalizados[key].valor = value;

    }



    /////////////////////////////////////////////////ajax////////////////////////////////
    function getCamposPersonalizados() {

         $.ajax({
            type: "get",
            headers: {
                "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
            },
            dataType: "json",
            url: '@Url.Action("GetCamposPersonalizados", "Contacto")',
            data: {idContacto: @Model.IdContacto},
            success: function (data) {

                camposPersonalizados = data;

                for (var i = 0; i < data.length; i++) {
                    var idCampoContacto = 0;
                    var valor = '';
                    if (data[i].tbCrContactosCamposPersonalizados.length != 0) {
                        idCampoContacto = data[i].tbCrContactosCamposPersonalizados[0].id;
                        valor = data[i].tbCrContactosCamposPersonalizados[0].valor;
                    }
                    var model = {
                        id: idCampoContacto,
                        idContacto: @Model.IdContacto,
                        idCampoPersonalizados: data[i].id,
                        valor: valor
                    };

                    ccPersonalizados.push(model);

                }

                cargarCamposPersonalizados(camposPersonalizados);
            },
            error: function (err, scnd) {
                cargarAlert('@Lb["errorGeneral"]');
                console.log(err.statusText);
            }
         });
    }

    function getTipoClientes() {

         $.ajax({
            type: "get",
            headers: {
                "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
            },
            dataType: "json",
            url: '@Url.Action("GetCamposPersonalizados", "Contacto")',
            data: {id: @Model.IdContacto},
            success: function (data) {

                 camposPersonalizados = data;
                 cargarCamposPersonalizados(camposPersonalizados);
            },
            error: function (err, scnd) {
                cargarAlert('@Lb["errorGeneral"]');
                console.log(err.statusText);
            }
         });
    }




    /////////////////////////////////////////////////////////////////manejo del dom//////////////////////////////////////////////

   
    function getProvincias() {
        if ($("#Pais option:selected").text() === "Costa Rica") {
            
            $.ajax({
                type: "POST",
                url: '@Url.Action("Provincias", "Contacto")',
                success: function (data) {
                    for (var i = 0; i < data.length; i++) {
                        $("#Provincia").append('<option class="provin" value=' + data[i].idProvincia + '>' + data[i].descProvincia+' </option>');
                    }
                    $("#Provincia").prop("disabled", false);
                    $("#Provincia").trigger("change");
                },
                error: function (err, scnd) {
                    console.log(err.statusText);
                }

            });

        } else {
            $("#Provincia").prop("disabled", true);
            $("#Canton").prop("disabled", true);
            $("#Distrito").prop("disabled", true);
            $("#Provincia").find('option').remove();
            $("#Canton").find('option').remove();
            $("#Distrito").find('option').remove();
        }      
    }

    function getCantones(idProvincia) {
        $("#Canton").find('option').remove();
        $.ajax({
            type: "POST",
            url: '@Url.Action("Cantones", "Contacto")',
            data: { idProvincia: idProvincia },
            success: function (data) {

                for (var i = 0; i < data.length; i++) {
                    $("#Canton").append('<option class="canton" value=' + data[i].idCanton + '>' + data[i].descCanton+' </option>');
                }
                $("#Canton").prop("disabled", false);
                $("#Canton").trigger("change");
            },

            error: function (err, scnd) {
                console.log(err.statusText);
                }

        });
    }

    function getDistritos(value) {
        $("#Distrito").find('option').remove();
        $.ajax({
                    
            type: "POST",
            url: '@Url.Action("Distritos", "Contacto")',
            data: { idDistrito: value, idProvincia: $('#Provincia').val()},
            success: function (data) {


                for (var i = 0; i < data.length; i++) {
                    $("#Distrito").append('<option class="distrito" value=' + data[i].idDistrito + '>' + data[i].descDistrito+' </option>');
                }

                $("#Distrito").prop("disabled", false);
                
            },

            error: function (err, scnd) {
                console.log(err.statusText);
            }

        });
    }

    function cargarCamposPersonalizados(data) {

        var contador = 0;
        var input = '';
        for (var i = 0; i < data.length; i++) {

            var value = '';
            if (data[i].tbCrContactosCamposPersonalizados.length != 0) {
                value = data[i].tbCrContactosCamposPersonalizados[0].valor;
            }

            if (data[i].tipo != "lista") {

                if (data[i].tipo === "checkbox") {
                    input = '<div class="form-group col-md-2 col-sm-3 col-xs-12" >'
                        + '<label for="' + data[i].id + '"> ' + data[i].nombre + ' <input onchange="editarCCPersonalizado(value, ' + contador + ')" id="' + data[i].id + '" type="' + data[i].tipo + '" checked="' + value + '" /></label>'
                        + '</div > ';
                }
                else {
                    input = '<div class="form-group col-md-4 col-sm-4 col-xs-12">'
                        + '<label for="' + data[i].id + '">' + data[i].nombre + ':</label>'
                        + '<input onchange="editarCCPersonalizado(value, ' + contador + ')" id="' + data[i].id + '" class="form-control" value="' + value + '" type="' + data[i].tipo + '" />'
                        + '</div>';
                }
            }
            else {
                var valoresLista = '';
                for (var k = 0; k < data[i].tbCrListaDesplegables.length; k++) {

                    var selected = '';
                    if (data[i].tbCrListaDesplegables[k].id.toString() === value) {
                        selected = 'selected';
                    }

                    valoresLista += '<option ' + selected + ' value="' + data[i].tbCrListaDesplegables[k].id + '" >' + data[i].tbCrListaDesplegables[k].valor + '</option>';
                }

                input = '<div class="form-group col-md-4 col-sm-4 col-xs-12">'
                    + '<label for="' + data[i].id + '">' + data[i].nombre + ':</label>'
                    + '<select onchange="editarCCPersonalizado(value, ' + contador + ')" id="' + data[i].id + '" class="form-control">'
                    + valoresLista
                    + '</select></div>';
            }

            contador++;
            $('#frmCP').append(input);

        }


    }
    

    function tipoCedula(key) {

        $cedula.removeClass("cedFisica cedJuridica cedDimex cedNite");

        switch (key) {

            case "1":
                $cedula.addClass("cedFisica");
                $cedula.prop('placeholder', "0-0000-0000");
                break;
            case "2":
                $cedula.addClass("cedJuridica");
                $cedula.prop('placeholder', "0-000-000000");
                break;
            case "3":
                $cedula.addClass("cedDimex");
                $cedula.prop('placeholder', "000000000000");
                break;
            case "4":
                $cedula.addClass("cedNite");
                $cedula.prop('placeholder', "000000000000");
                break;
        }
    }

    function ocultarCamposNombre(value) {
        if (value === 1) {
            $('.nombrePersona').prop("hidden", false);
            $('.nombreEmpresa').prop("hidden", true);
        }
        else {
            $('.nombrePersona').prop("hidden", true);
            $('.nombreEmpresa').prop("hidden", false);
        }

    }

    function mostrarTipoProveedor() {

        if ($('#Proveedor').prop('checked'))
            $('.tipoProveedor').prop('hidden', false);
        else
            $('.tipoProveedor').prop('hidden', true);
    }
    function mostrarTipoCliente() {
        if ($('#Cliente').prop('checked'))
            $('.tipoCliente').prop('hidden', false);
        else
            $('.tipoCliente').prop('hidden', true);
    }

    function cancelar() {
        bootbox.confirm("@Lb["confirmCancelar"]", function (result) {
            if (result)
                window.location.href = "@Url.Action("ListarContactos")";

        });
    }
</script>