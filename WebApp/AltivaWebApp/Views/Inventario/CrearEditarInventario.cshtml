@model AltivaWebApp.ViewModels.InventarioViewModel

@inject IStringLocalizer<SharedResources> SharedLocalizer
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@functions{
    public string GetAntiXsrfRequestToken()
    {
        return Xsrf.GetAndStoreTokens(Context).RequestToken;
    }
}
@{
    var habilitaVentaDirecta = "";
    var habilitaVentaOnline = "";

    if (ViewBag.accion == "1")
    {
        habilitaVentaDirecta = "Checked";
        habilitaVentaOnline = "Checked";
    }
    else
    {
        if (Model.HabilitarVentaDirecta)
        {
            habilitaVentaDirecta = "Checked";

            if (Model.HabilitarVentaOnline)
            {
                habilitaVentaOnline = "Checked";
            }
            else
            {
                habilitaVentaOnline = "";
            }
        }
        else
        {
            habilitaVentaDirecta = "";
        }
    }

    var bodegas = ViewData["bodegas"] as IList<TbPrBodega>;
}

@if (ViewBag.accion == "1")
{
    <h3 data-translate="nuevoItem">Nuevo Item</h3>
}
else
{

    <h3 data-translate="editarItem">Editar Item</h3>
}
<hr />
<div class="row">
    <div class="col-md-12 col-sm-12">
        <div class="form-group habilitaEdicionGroup">
            <input type="checkbox" class="form-check-input" id="habilitaEdicion" />
            <label data-translate="habilitaEdicion" class="form-check-label" for="habilitaEdicion">Habilitar Edición</label>
        </div>
    </div>
    <div class="col-md-12 col-sm-12 col-xs-12">
        <form id="formInventario">

            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="form-group" hidden>
                <label asp-for="IdInventario" class="control-label"></label>
                <input asp-for="IdInventario" class="form-control" />
                <span asp-validation-for="IdInventario" class="text-danger"></span>
            </div>
            <div class="row">
                <div class="form-group col-md-2">
                    <label asp-for="CantidadUnidad" class="control-label">@SharedLocalizer["Presentación"]</label>
                    <input asp-for="CantidadUnidad" value="@Model.CantidadUnidad.ToString().Replace(',', '.')" class="form-control numerico" />
                    <span id="presentacionValid" hidden class="text-danger">@SharedLocalizer["presentacionValid"].</span>
                </div>
                <div class="form-group col-md-2">
                    <label asp-for="IdUnidadMedida" class="control-label">@SharedLocalizer["UnidadMedida"]</label>
                    <select asp-for="IdUnidadMedida" id="unidades" class="form-control">
                        @{
                            foreach (var item in ViewData["unidades"] as IList<TbPrUnidadMedida>)
                            {
                                <option value="@item.Id">@item.Nombre</option>
                            }
                        }
                    </select>
                </div>

                <!--familia-->

                <div class="form-group col-md-4 col-sm-12">

                    <div class="row">
                        <div class="col-md-8 col-sm-12">
                            <label class="control-label">@SharedLocalizer["Familia"]</label>
                            <select id="familias" class="form-control search-key"></select>
                        </div>
                        <div class="col-md-4 col-sm-12">
                            <br />
                            <a class="btn btn-link crearEditarFamilia" id="crearFamilia">
                                <span style="font-size: 2rem"><i class="fas fa-plus-circle"></i></span>
                            </a>
                            <a class="btn btn-link crearEditarFamilia" id="editarFamilia">
                                <span style="font-size: 2rem"><i class="fas fa-edit"></i></span>
                            </a>
                        </div>
                    </div>
                </div> <!--Fin de familia-->

                <div class="form-group col-md-4 col-sm-12">
                    <label data-translate="impuesto" asp-for="ImpuestoVenta" class="control-label">@SharedLocalizer["Impuesto"] %</label>
                    <input id="impVenta" asp-for="ImpuestoVenta" class="form-control porc inputPorcentaje" />
                </div>
            </div>
            <div class="row">
                <div class="form-group col-md-4 col-sm-12">
                    <label asp-for="Codigo" class="control-label" data-translate="codigo">Codigo</label>
                    <input asp-for="Codigo" class="form-control" />
                    <span hidden id="codigoValid" class="text-danger">@SharedLocalizer["codigoValid"]</span>
                    <span hidden id="existeCodigoValid" class="text-danger">@SharedLocalizer["repetidoValid"].</span>
                </div>
                <div class="form-group col-md-4 col-sm-12">

                    <div class="row">
                        <div class="col-md-8 col-sm-12">
                            <label data-translate="subFamilia" class="control-label">Sub-Familia</label>
                            <select asp-for="IdSubFamilia" id="subFamilias" class="form-control search-key"></select>
                        </div>
                        <div class="col-md-4 col-sm-12">
                            <br />
                            <a class="btn btn-link crearEditarSubFamilia" id="editarSubFamilia">
                                <span style="font-size: 2rem"><i class="fas fa-edit"></i></span>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="form-group col-md-4 col-sm-12">
                    <label data-translate="costoPromedio" class="control-label">Costo Promedio</label>
                    <input readonly asp-for="CostoPromedioGeneral" value="@Model.CostoPromedioGeneral.ToString().Replace(',', '.')" class="form-control inputVentaDirecta" />
                </div>
            </div>
            <div class="row">
                <div class="form-group col-md-6 col-sm-12">
                    <label data-translate="descripcion" asp-for="Descripcion" class="control-label">Descripción</label>
                    <input id="txtDescripcion" maxlength="150" asp-for="Descripcion" class="form-control" />
                    <span id="descripcionValid" class="text-danger" hidden>@SharedLocalizer["descripcionValid"]</span>
                </div>

                <div class="form-group col-md-2" col-sm-12>
                    <label data-translate="moneda" asp-for="CodigoMoneda" class="control-label">Moneda</label>
                    <select asp-for="CodigoMoneda" id="moneda" class="form-control search-key">
                        @{
                            foreach (var item in ViewData["moneda"] as IList<TbSeMoneda>)
                            {
                                <option value="@item.Codigo">@item.Nombre</option>
                            }

                        }

                    </select>
                </div>

                <div class="form-group col-md-4 col-sm-12">
                    <label data-translate="ultimoCosto" asp-for="UltimoPrecioCompra" class="control-label">Último Costo</label>
                    <input readonly asp-for="UltimoPrecioCompra" value="@Model.UltimoPrecioCompra.ToString().Replace(',', '.')" class="form-control inputVentaDirecta" />
                </div>

            </div>
            <div class="row">
                <div class="form-group col-md-8 col-sm-12">
                    <label data-translate="nota" asp-for="Notas" class="control-label">Nota</label>
                    <textarea maxlength="500" rows="5" asp-for="Notas" class="form-control"></textarea>
                </div>
                <div class="form-group col-md-4 col-sm-12">
                    <label data-translate="factorAprovechamiento" class="control-label">Factor de Aprovechamiento %</label>
                    <input asp-for="FactorAprovechamiento" value="@Model.FactorAprovechamiento.ToString().Replace(',', '.')" class="form-control numerico" />
                </div>
            </div>
            <div class="row">

                <br />

                <div class="form-group col-md-12 col-sm-12">
                    <input type="checkbox" class="form-check-input" id="habilitaVenta" asp-for="HabilitarVentaDirecta" />
                    <label data-translate="habilitaVenta" class="form-check-label" for="habilitaVenta">Habilitar Venta Directa </label>
                </div>
            </div>


            <!--///////////////////////////venta directa form///////////////////////////////-->

            <div class="well collapse ventaDirectaForm">
                <div class="row ">

                    <div class="col-md-2 col-sm-12">
                        <br />
                        <label data-translate="precioContado">Precio Contado:</label>
                    </div>
                    <div class="form-group col-md-2 col-sm-12">
                        <label data-translate="utilidadDeseada" class="control-label"> Utilidad deseada %</label>
                        <input id="utilidadDeseada" asp-for="UtilidadDeseada" value="@Model.UtilidadDeseada.ToString().Replace(',', '.')" class="form-control numerico" />
                    </div>
                    <div class="form-group col-md-2 col-sm-12">
                        <label data-translate="precioSinImpuesto" class="control-label">Precio sin Impuesto</label>
                        <input id="precioVenta" asp-for="PrecioVenta" value="@Model.PrecioVenta.ToString().Replace(',', '.')" class="form-control inputVentaDirecta " />
                    </div>
                    <div class="form-group col-md-2 col-sm-12">
                        <label data-translate="precioVentaFinal" asp-for="PrecioVentaFinal" class="control-label">Precio Venta Final</label>
                        <input id="precioVentaFinal" asp-for="PrecioVentaFinal" value="@Model.PrecioVentaFinal.ToString().Replace(',', '.')" class="form-control inputVentaDirecta" />
                    </div>
                </div>
                <br />
                <div class="row">
                    <div class="col-md-2">
                        <label data-translate="precioCredito">Precio Crédito:</label>
                    </div>
                    <div class="form-group col-md-2 col-sm-12">
                        <input id="utilidadCredito" asp-for="UtilidadCredito" value="@Model.UtilidadCredito.ToString().Replace(',', '.')" class="form-control numerico  inputPorcentaje" />
                    </div>

                    <div class="form-group col-md-2 col-sm-12">
                        <input id="precioCredito" asp-for="PrecioCredito" value="@Model.PrecioCredito.ToString().Replace(',', '.')" class="form-control inputVentaDirecta" />
                    </div>
                    <div class="form-group col-md-2 col-sm-12">
                        <input id="precioCreditoFinal" asp-for="PrecioCreditoFinal" value="@Model.PrecioCreditoFinal.ToString().Replace(',', '.')" class="form-control inputVentaDirecta" />
                    </div>

                </div>
                <br />
                <div class="row">

                    <div class="col-md-2 col-sm-6">
                        <label data-translate="precioCredito">Precio Temporal:</label>
                    </div>
                    <div class="form-group col-md-2 col-sm-12">
                        <input id="utilidadTemporal" asp-for="UtilidadTemporal" value="@Model.UtilidadTemporal.ToString().Replace(',', '.')" class="form-control numerico inputPorcentaje" />
                    </div>
                    <div class="form-group col-md-2 col-sm-12">
                        <input id="precioTemporal" asp-for="PrecioTemporal" value="@Model.PrecioTemporal.ToString().Replace(',', '.')" class="form-control inputVentaDirecta" />
                    </div>
                    <div class="form-group col-md-2 col-sm-12">
                        <input id="precioTemporalFinal" asp-for="PrecioTemporalFinal" value="@Model.PrecioTemporalFinal.ToString().Replace(',', '.')" class="form-control inputVentaDirecta" />
                    </div>
                </div>

                <div class="row">
                    <div class="form-group col-md-6 col-sm-12">
                        <label data-translate="descripcionVenta" asp-for="DescripcionVenta" class="control-label">Descripción de Venta</label>
                        <input id="txtDescripcionVenta" asp-for="DescripcionVenta" class="form-control" />
                        <span hidden id="descripcionVentaValid" data-translate="validacionDescripcionVenta" class="text-danger">Descripción de venta no puede ir vacía</span>
                    </div>
                    <div class="form-group col-md-2 col-sm-12">
                        <label data-translate="moneda" class="control-label">Moneda de Venta</label>
                        <select asp-for="CodigoMonedaVenta" id="monedaVenta" class="form-control search-key">
                            @{
                                foreach (var item in ViewData["moneda"] as IList<TbSeMoneda>)
                                {
                                    <option value="@item.Codigo">@item.Nombre</option>
                                }

                            }

                        </select>
                    </div>
                </div>


                <br />
                <div class="form-group col-md-12 col-sm-12">
                    <input type="checkbox" class="form-check-input" id="habilitaVentaOnline" asp-for="HabilitarVentaOnline" />
                    <label data-translate="habilitaVentaOnline" class="form-check-label" for="habilitaVentaOnline">Habilitar Venta Online </label>
                </div>
                <br />

                <!--Habilitar Venta online-->
                <br />
                <div class="row well collapse ventaOnlineForm">


                    <!--Familias online-->
                    <div class="col-md-4 col-sm-4 col-xs-10">
                        <label class="control-label" data-translate="familia">Familia</label>
                        <select id="familiasOnline" class="form-control search-key"></select>
                    </div>
                    <div class="col-md-2 col-sm-2 col-xs-2">
                        <br />
                        <a class="btn btn-link crearEditarFamiliaOnline" id="crearFamiliaOnline">
                            <span style="font-size: 2rem"><i class="fas fa-plus-circle"></i></span>
                        </a>
                        <a class="btn btn-link crearEditarFamiliaOnline" id="editarFamiliaOnline">
                            <span style="font-size: 2rem"><i class="fas fa-edit"></i></span>
                        </a>
                    </div>
                    <!--Fin familia online-->
                    <!--SubFamiliaOnline-->

                    <div class="col-md-4 col-sm-4 col-xs-10">
                        <label data-translate="subFamilia" class="control-label">Sub-Familia</label>
                        <select asp-for="IdFamiliaOnline" id="subFamiliasOnline" class="form-control search-key"></select>
                    </div>
                    <div class="col-md-2 col-sm-2 col-xs-2">
                        <br />
                        <a class="btn btn-link crearEditarSubFamiliaOnline" id="editarSubFamiliaOnline">
                            <span style="font-size: 2rem"><i class="fas fa-edit"></i></span>
                        </a>
                    </div>



                    <!--Fn SubFamiliaOnline-->


                    <br />
                    <div class="form-group col-md-6 col-sm-6 col-xs-12">
                        <label data-translate="nombreCarrito" asp-for="NombreCarrito" class="control-label">Nombre de Carrito de Compras</label>
                        <input id="txtNombreCarrito" asp-for="NombreCarrito" class="form-control" />
                        <span hidden id="nombreCarritoValid" class="text-danger">@SharedLocalizer["nombreRequired"]</span>
                    </div>

                    <div class="form-group col-md-6 col-sm-6 col-xs-12">
                        <label data-translate="abreviacionFactura" asp-for="AbreviacionFactura" class="control-label">Abreviacion para Facturas</label>
                        <input id="txtAbreviacionFactura" asp-for="AbreviacionFactura" class="form-control" />
                        <span hidden id="abreviacionFacturaValid" class="text-danger">@SharedLocalizer["abreviacionValid"]</span>
                    </div>

                    <div class="form-group col-md-3 col-sm-3 col-xs-12">
                        <label data-translate="moneda" class="control-label">Moneda de Venta</label>
                        <select asp-for="CodigoMonedaOnline" id="monedaVentaOnline" class="form-control search-key">
                            @{
                                foreach (var item in ViewData["moneda"] as IList<TbSeMoneda>)
                                {
                                    <option value="@item.Codigo">@item.Nombre</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="form-group col-md-3 col-sm-6 col-xs-12">
                        <label data-translate="precioVentaOnline" asp-for="PrecioVentaOnline" class="control-label">Precio de Venta Online</label>
                        <input id="precioVentaOnline" asp-for="PrecioVentaOnline" value="@Model.PrecioVentaOnline.ToString().Replace(',', '.')" class="form-control inputVentaDirecta" />
                        <span hidden id="precioVentaOnlineValid" class="text-danger">@SharedLocalizer["precioVentaOnlineValid"]</span>
                    </div>

                    <div class="form-group col-md-6 col-sm-6 col-xs-12">
                        <label data-translate="SkuOnline" asp-for="SkuOnline" class="control-label">Sku Online</label>
                        <input id="txtSkuOnline" asp-for="SkuOnline" class="form-control" />
                        <span hidden id="skuOnline" class="text-danger">@SharedLocalizer["skuValid"]</span>
                    </div>
                </div>
            </div>

            <!--Fin de tabs fotos y caracteristicas-->
            <div class="form-group" hidden>
                <label asp-for="ExistenciaGeneral" class="control-label"></label>
                <input asp-for="ExistenciaGeneral" class="form-control" />
                <span asp-validation-for="ExistenciaGeneral" class="text-danger"></span>
            </div>

            <div class="form-group" hidden>
                <div class="checkbox">
                    <label>
                        <input asp-for="Inactiva" /> @Html.DisplayNameFor(model => model.Inactiva)
                    </label>
                </div>
            </div>
            <div class="form-group" hidden>
                <label asp-for="IdUsuario" class="control-label"></label>
                <input asp-for="IdUsuario" class="form-control" />
                <span asp-validation-for="IdUsuario" class="text-danger"></span>
            </div>

        </form>

    </div>

    <div class="col-md-12">
        <!--Tabs de fotos y caracteristicas-->
        @if (Model.IdInventario != 0)
        {
            <div class="container mt-3" id="tabs">

                <br>
                <!-- Nav tabs -->

                <ul class="nav nav-tabs " id="tabs">
                    <li class="nav-item active">
                        <a class="nav-link" data-translate="fotos" data-toggle="tab" href="#fotosOnline">@SharedLocalizer["Fotos"]</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#caracteristicasOnline">@SharedLocalizer["Caracteristicas"]</a>
                    </li>

                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div id="fotosOnline" class="container tab-pane active">

                        <br />

                        <button id="nuevaImagen" class="btn btn-success btn-sm" type="button" data-toggle="modal" data-target="#modalImagenesOnline"> Cargar Imagen</button>

                        <br />

                        <div id="partialImagenes">

                        </div>


                    </div>


                    <div id="caracteristicasOnline" class="container tab-pane">

                        <br />

                        <button id="nuevaCaracteristica" class="btn btn-success btn-sm" type="button" data-toggle="modal" data-target="#modalCaracteristicas"> Cargar Caracteristica</button>

                        <br />

                        <div id="partialCaracteristicas">

                        </div>

                    </div>

                </div>


                <br />


            </div>
        }
    </div>
</div>

<!--///////////////////////////fin venta directa fomr///////////////////////////////-->



<div class="container mt-3" id="tabs">

    <br>
    <!-- Nav tabs -->

    <ul class="nav nav-tabs " id="tabs">
        <li class="nav-item active">
            <a class="nav-link" data-translate="bodegas" data-toggle="tab" href="#bodegas">@SharedLocalizer["Bodegas"]</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#inventarioEquivalencias">@SharedLocalizer["Equivalencias"]</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" data-translate="comentarios" href="#inventarioComentarios">@SharedLocalizer["Comentarios"]</a>
        </li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">

        <input hidden readonly class="monedaFormatter" id="formatterMoneda" />

        <div id="bodegas" class="container tab-pane active">

            <div class="row">
                <div class="col-md-12 table-responsive">
                    <span hidden id="itemSinBodega" class="text-danger">@SharedLocalizer["bodegaSinItemValid"].</span>
                    <table class="table table-bordered" id="tblBodegas" style="min-width:900px">
                        <thead>
                            <tr>
                                <th style="width:20%">
                                    <span data-translate="bodega">Bodega</span>
                                </th>
                                <th style="width:10%">
                                    <span data-translate="minima">Mínima</span>
                                </th>
                                <th style="width:10%">
                                    <span data-translate="media">Media</span>
                                </th>
                                <th style="width:10%">
                                    <span data-translate="maxima">Máxima</span>
                                </th>
                                <th style="width:10%">
                                    <span data-translate="actual">Actual</span>
                                </th>
                                <th style="width:10%">
                                    <span data-translate="costoPromedio">Costo Promedio</span>
                                </th>
                                <th style="width:20%">
                                    <span data-translate="saldo">Saldo</span>
                                </th>
                                <th style="width:10%"><span data-translate="accion">Acción</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bodegaInventarioForm">
                                <td>
                                    <select class="form-control" id="bodega">
                                        @{
                                            foreach (var item in ViewData["bodegas"] as IList<TbPrBodega>)
                                            {
                                                <option value="@item.Id">@item.Nombre</option>
                                            }

                                        }

                                    </select>
                                </td>
                                <td><input class="form-control numerico" id="minima" /></td>
                                <td><input class="form-control numerico" id="media" /></td>
                                <td><input class="form-control numerico" id="maxima" /></td>
                                <td><input class="form-control" readonly id="actual" /></td>
                                <td><input class="form-control" readonly id="costoPromedio" /></td>
                                <td><input class="form-control" readonly id="saldo" /></td>
                                <td><button class="btn btn-link" id="agregarBodega"><i class="fas fa-save"></i></button></td>
                            </tr>


                        </tbody>
                    </table>
                </div>

            </div>



        </div>

        <div id="inventarioComentarios" class="container tab-pane">
            <br>

            <div class="col-md-12">
                <div id="comentarios">

                </div>
            </div>
        </div>
        <div id="ventaOnline" class="container tab-pane"></div>

        <div id="inventarioEquivalencias" class="container tab-pane">
            <br>
            <div class="col-md-12 table-responsive" id="equivalencias">

            </div>

        </div>

    </div>
</div>

<br />
<div class="row">
    <div class="form-group col-md-12">
        <button id="btnGuardar" class="btn btn-success"><span data-translate="guardar">Guardar</span> <span><i class="fas fa-save"></i></span></button>
        <a class="btn btn-default" id="btnCancelar" data-translate="cancelar">@SharedLocalizer["Cancelar"]</a>
    </div>
</div>




<div>
    <!-- Modal -->
    <div class="modal fade" id="modalFamilia" tabindex="-1" role="dialog" aria-labelledby="familiaModallabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body" id="crearEditarPartial">

                </div>
            </div>
        </div>
    </div>
</div>


<div>
    <!-- Modal -->
    <div class="modal fade" id="modalFamiliaOnline" tabindex="-1" role="dialog" aria-labelledby="familiaOnlineModallabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body" id="crearEditarPartialOnline">

                </div>
            </div>
        </div>
    </div>
</div>

<div>
    <!-- Modal Imagenes-->
    <div class="modal fade" id="modalImagenesOnline" tabindex="-1" role="dialog" aria-labelledby="imagenesModallabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 data-translate="nuevaImagen" class="modal-title" id="imagnesModallabel">Subir Imagenes</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <form id="frmImagenesOline" method="post" enctype="multipart/form-data" asp-controller="Inventario" asp-action="CargarImagenesInventario" asp-route-id="@Model.IdInventario">
                        <div class="form-group">
                            <div class="input-group input-group-sm mb-3">
                                <div class="input-group-prepend custom-file">
                                    <span class="input-group-text" id="inputGroup-sizing-sm">@SharedLocalizer["cargarFoto"]</span>
                                </div>
                                <input id="fileUpload" type="file" multiple="multiple" name="files" accept="image/*" class="form-control custom-file-input">
                                <span hidden id="tamanoArchivo" class="text-danger">@SharedLocalizer["tamanoArchivo"]</span>
                                <span hidden id="tipoArchivo" class="text-danger">@SharedLocalizer["tipoArchivo"]</span>
                            </div>
                        </div>


                        <button id="guardarFoto" class="btn btn-success btn-sm" type="submit">
                            <span data-translate="geBtnCambiarLogo">@SharedLocalizer["Guardar"]:</span><span> <i class="fas fa-save"></i></span>
                        </button>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

<div>
    <!-- Modal Caracteriscas -->
    <div class="modal fade" id="modalCaracteristicas" tabindex="-1" role="dialog" aria-labelledby="caracterisitcasModallabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 data-translate="nuevaCaracterisca" class="modal-title" id="caracteristicasModallabel">Ingresar Caracteristicas</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <form>
                        <div class="form-group">
                            <div class="form-group col-md-6">
                                <label data-translate="caracteristicasOnline" class="control-label">Caracteristicas Online</label>
                                <input id="txtCaracteriscas" class="form-control" />
                                <span hidden id="caracteristicasValid" data-translate="ValidacionCaracteristicas" class="text-danger"></span>
                            </div>
                        </div>

                    </form>

                    <button id="guardarCaracteristicas" onclick="guardarCaracteristica()" class="btn btn-success">
                        <span>@SharedLocalizer["Guardar"]</span><span> <i class="fas fa-save"></i></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="~/js/comentario.js"></script>

<script>

    var contadorFila = 0;
    var inventarioBodega = [];
    var inventarioBodegaNuevas = [];

    $(document).ready(function () {

        if (@Model.IdInventario != 0) {

            GetComentarios("Inventario", @Model.IdInventario);

            $('#impVenta').val("@Model.ImpuestoVenta.ToString().Replace(',', '.')");
        }

        $(".inputVentaDirecta").inputmask({
            'alias': 'decimal',
            rightAlign: true,
        });

        $(".numerico").inputmask({
            'alias': 'decimal',
            rightAlign: false,
        });

        $(".monedaFormatter").inputmask('currency', {
            prefix: " ",
            rightAlign: true
        });

        $('#guardarFoto').attr('disabled', true);


        $(".porc").inputmask({
            'alias': 'percentage',
            rightAlign: false,
        });


        if ($('#habilitaVenta').prop('checked')){
            $('.ventaDirectaForm').collapse('toggle');
        }

        if ($('#habilitaVentaOnline').prop('checked')) {
            $('.ventaOnlineForm').collapse('toggle');
        }

        var familias = [];
        var subFamilia = [];
        var familiasOnline = [];
        var subFamiliaOnline = [];

        getFamilias(null, null);
        getFamiliasOnline(null, null);
        cambiarValor();

        if (@Model.IdInventario != 0) {
            $('#unidades').attr('disabled', true);
            getBodegas();
            getEquivalencias();
            getImagenes();
            getCaracteristicas();
        }
        else
            $('.habilitaEdicionGroup').attr('hidden', true);

        $('#modalCaracteristicas').on('hidden.bs.modal', function (e) {
            $('#txtCaracteriscas').val('');
        });

        $('#habilitaEdicion').change(function () {
            if ($(this).prop('checked'))
                $('#unidades').attr('disabled', false);
            else
                $('#unidades').attr('disabled', true);


        });

        $('#familias').change(function () {

            setSubFamilia($(this).val(), 0);

        });

        $('#familiasOnline').change(function () {

            setSubFamiliaOnline($(this).val(), 0);

        });

        $('#btnCancelar').click(function () {
            bootbox.confirm("@SharedLocalizer["confirmCancelar"]", function (result) { if (result) window.location.href = "@Url.Action("ListarInventario")"; });
        });

        $('#habilitaVenta').change(function () {

            $('.ventaDirectaForm').collapse('toggle');

            if (!$('#habilitaVenta').prop('checked')) {
                $('.inputVentaDirecta').val(0);
                $('#txtDescripcionVenta').val("");
            }
            else
                $('#txtDescripcionVenta').val("Ninguna");

        });

         $('#habilitaVentaOnline').change(function () {

            $('.ventaOnlineForm').collapse('toggle');

             if (!$('#habilitaVentaOnline').prop('checked')) {
                 $('.inputVentaOnline').val(0);
                 //$('#txtNombreCarrito').val("");
             }
             //else
        });

        $('#unidades').change(function () {
            $('#unidadesInput').val($(this).val());
        });

        $('#agregarBodega').click(function () {

            var flag = false;

            var bodega = parseInt($('#bodega option:selected').val());

            for (var i = 0; i < inventarioBodega.length; i++) {
                if (bodega === inventarioBodega[i].idBodega) {
                    cargarAlert("@SharedLocalizer["repetidoValid"]");
                    flag = true;
                }
            }
            if (!flag) {


                var model = {
                    id: 0,
                    idBodegaNavigation: { nombre: $('#bodega option:selected').html() },
                    idBodega: parseInt($('#bodega').val()),
                    existenciaMinima: parseFloat($('#minima').val()),
                    existenciaMedia: parseFloat($('#media').val()),
                    existenciaMaxima: parseFloat($('#maxima').val()),
                    existenciaBodega: $('#actual').val(),
                    costoPromedioBodega: parseFloat($('#costoPromedio').val()),
                    saldoBodega: 0,//$('#saldo').val(),
                    idInventario: 0,
                    costoPromedioBodega: 0
                };

                var flag2 = true;

                if (model.existenciaMinima > 0 && model.existenciaMedia > 0 && model.existenciaMaxima > 0) {

                    if (model.existenciaMinima >= model.existenciaMedia) {
                        cargarAlert('@SharedLocalizer["minimaValid"]');
                        flag2 = false;
                    }

                    else if (model.existenciaMedia >= model.existenciaMaxima) {
                        cargarAlert('@SharedLocalizer["mediaValid"]');
                        flag2 = false;
                    }

                    if (flag2) {
                        inventarioBodegaNuevas.push(model);
                        inventarioBodega.push(model);
                        cargarDatos(inventarioBodega);
                        $('#minima').val(0);
                        $('#media').val(0);
                        $('#maxima').val(0);
                    }
                }
                else {
                    cargarAlert("@SharedLocalizer["existenciaValid"]");
                }
            }
        });

        $('#fileUpload').bind('change', function () {

        var file = $(this)[0].files[0];

        if ($(this).val() != '') {
            $('#guardarFoto').attr('disabled', false);

            var e = 0;
            e = + file.size;

            if (e > 60000) {
                $('#tamanoArchivo').attr('hidden', false);
                $(this).val('');
            }

            if (!(/\.(jpg|png|gif)$/i).test(file.name)) {
                $('#tipoArchivo').attr('hidden', false);
                $(this).val('');
            }
        }
        else
            $('#guardarFoto').attr('disabled', true);
        });

        $('#btnGuardar').click(function () {

            var model = $('#formInventario').serializeArray();



            for (var i = 0; i < model.length; i++) {
                if (model[i].name === "ImpuestoVenta" || model[i].name === "CantidaUnidad" || model[i].name === "FactorAprovechamiento" || model[i].name === "UtilidadDeseada" || model[i].name === "PrecioVenta"
                    || model[i].name === "PrecioVentaFinal" || model[i].name === "UtilidadCredito" || model[i].name === "PrecioCredito" || model[i].name === "PrecioCreditoFinal" || model[i].name === "UtilidadTemporal"
                    || model[i].name === "PrecioTemporal" || model[i].name === "PrecioTemporalFinal" || model[i].name === "PrecioVentaOnline"
                )
                {
                    model[i].value = model[i].value.replace("%", "");
                    model[i].value = model[i].value.replace(".", ",");
                }
            }

            var url = '@Url.Action("CrearEditarInventario", "Inventario", new { id = Model.IdInventario })';

            if (formIsValid())

                     $.ajax({
                        type: "post",
                        headers: {
                            "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                        },
                        url: url,
                        data: model,
                         success: function (data) {

                             if (data.id != 0) {
                                 if (inventarioBodega.length != 0) {
                                     guardarRelacionIB(data.id);
                                 }
                                 else {
                                     window.location.href = '@Url.Action("ListarInventario", "Inventario")';
                                 }
                             }
                             else {
                                 $('#existeCodigoValid').attr('hidden', false);
                             }

                        },
                         error: function (err, scnd) {
                            cargarAlert("@SharedLocalizer["errorGeneral"]")
                            console.log(err.statusText);
                        }
                    });

        });




        $('#editarFamilia').click(function () {

            var url = '@Url.Action("EditarFamilia", "Familia", new { id = "__id__" })'.replace("__id__", $('#familias').val() );//'../FamiliasOnline/Editar-Familia/' + $('#familiasOnline').val();
            crearEditarFamilia(url);
        });

        $('#crearFamilia').click(function () {

            var url = "@Url.Action("CrearFamilia", "Familia")";//'../FamiliasOnline/Crear-Familia/';
            crearEditarFamilia(url);
        });

        $('#editarSubFamilia').click(function () {

            var url = '@Url.Action("EditarFamilia", "Familia", new { id = "__id__" })'.replace("__id__", $('#subFamilias').val());
            crearEditarFamilia(url);
        });

        $('#crearSubFamilia').click(function () {

            var url = "@Url.Action("CrearFamilia", "Familia")";
            crearEditarFamilia(url);

        });



        $('#editarFamiliaOnline').click(function () {

            var url = '@Url.Action("EditarFamilia", "FamiliaVentaOnline", new { id = "__id__" })'.replace("__id__", $('#familiasOnline').val() );//'../FamiliasOnline/Editar-Familia/' + $('#familiasOnline').val();
            crearEditarFamiliaOnline(url);
        });

        $('#crearFamiliaOnline').click(function () {

            var url = "@Url.Action("CrearFamilia", "FamiliaVentaOnline")";//'../FamiliasOnline/Crear-Familia/';
            crearEditarFamiliaOnline(url);
        });

        $('#editarSubFamiliaOnline').click(function () {

            var url = '@Url.Action("EditarFamilia", "FamiliaVentaOnline", new { id = "__id__" })'.replace("__id__", $('#subFamiliasOnline').val() ); ;//'../FamiliasOnline/Editar-Familia/' + $('#subFamiliasOnline').val();
            crearEditarFamiliaOnline(url);
        });

        $('#crearSubFamiliaOnline').click(function () {

            var url = "@Url.Action("CrearFamilia", "FamiliaVentaOnline")"; //'../FamiliasOnline/Crear-Familia/';
            crearEditarFamiliaOnline(url);
        });






    }); // FIn del Document ready

    function crearEditarFamilia (url) {

            $.ajax({
                type: "get",
                headers: {
                    "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                },
                url: url,
                success: function (data) {

                    $('#crearEditarPartial').html(data);
                    $('#modalFamilia').modal('show');
                },
                error: function (err, scnd) {
                    cargarAlert("@SharedLocalizer["errorGeneral"]");
                    console.log(err.statusText);
                }
            });
    }

    function crearEditarFamiliaOnline (url) {

            $.ajax({
                type: "get",
                headers: {
                    "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                },
                url: url,
                success: function (data) {

                    $('#crearEditarPartialOnline').html(data);
                    $('#modalFamiliaOnline').modal('show');
                },
                error: function (err, scnd) {
                    cargarAlert("@SharedLocalizer["errorGeneral"]");
                    console.log(err.statusText);
                }
            });
    }

    function getFamilias(_idP, _idH) {

            var url = '@Url.Action("GetFamilia", "Inventario")';
            $.ajax({
                type: "get",
                headers: {
                    "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                },
                url: url,
                success: function (data) {

                    familias = data;
                    var idP = 0;
                    var idH = @Model.IdSubFamilia

                    if (_idH !== null)
                        idH = _idH;

                    $("#familias option").remove();

                    for (var i = 0; i < data.length; i++) {
                        var o = new Option(data[i].descripcion, data[i].id);

                       // if (idH !== 0)
                            for (var j = 0; j < data[i].inverseIdFamiliaNavigation.length; j++) {
                                if (data[i].inverseIdFamiliaNavigation[j].id === idH)
                                    $(o).attr('selected', true);
                            }
                        //else
                        //    $(o).attr('selected', true);
                        $("#familias").append(o);
                    }

                    idP = $("#familias").val();

                    if (_idP !== null) {
                        idP = _idP;

                    }
                    $("#familias").val(idP);

                    setSubFamilia(idP, idH);
                },
                error: function (err, scnd) {
                    console.log(err.statusText);
                    cargarAlert("@SharedLocalizer["errorGeneral"]");
                }
            });
        }

    function getFamiliasOnline(_idP, _idH) {

            var url = '@Url.Action("GetFamiliaOnline", "Inventario")';
            $.ajax({
                type: "get",
                headers: {
                    "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                },
                url: url,
                success: function (data) {

                    familiasOnline = data;
                    var idP = 0;
                    var idH = @Model.IdFamiliaOnline

                    if (_idH !== null)
                        idH = _idH;

                    $("#familiasOnline option").remove();

                    for (var i = 0; i < data.length; i++) {
                        var o = new Option(data[i].descripcion, data[i].id);

                       // if (idH !== 0)
                            for (var j = 0; j < data[i].inverseIdFamiliaNavigation.length; j++) {
                                if (data[i].inverseIdFamiliaNavigation[j].id === idH)
                                    $(o).attr('selected', true);
                            }
                        //else
                        //    $(o).attr('selected', true);
                        $("#familiasOnline").append(o);
                    }

                    idP = $("#familiasOnline").val();

                    if (_idP !== null) {
                        idP = _idP;

                    }
                    $("#familiasOnline").val(idP);

                    setSubFamiliaOnline(idP, idH);

                },
                error: function (err, scnd) {
                    console.log(err.statusText);
                    cargarAlert("@SharedLocalizer["errorGeneral"]");
                }
            });
        }

        function getBodegas() {

            var url = '@Url.Action("GetBodegas", "Inventario")';
            $.ajax({
                type: "get",
                headers: {
                    "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                },
                url: url,
                data: {id: @Model.IdInventario},
                success: function (data) {

                    //inventarioBodegaOriginal = JSON.parse(JSON.stringify(data));
                    inventarioBodega = JSON.parse(JSON.stringify(data));
                    cargarDatos(data);
                },
                error: function (err, scnd) {
                    cargarAlert("@SharedLocalizer["errorGeneral"]");
                    console.log(err.statusText);
                }
            });
        }

        function getEquivalencias() {

            var url = '@Url.Action("_ListarEquivalencias", "Inventario")';
            $.ajax({
                type: "get",
                headers: {
                    "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                },
                url: url,
                data: {id: @Model.IdInventario},
                success: function (data) {
                    $('#equivalencias').html(data);
                },
                error: function (err, scnd) {
                    cargarAlert('@SharedLocalizer["errorGeneral"]');
                    console.log(err.statusText);
                }
            });
        }

        function getImagenes() {

            var url = '@Url.Action("_ListarImagenes", "Inventario")';
            $.ajax({
                type: "get",
                headers: {
                    "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                },
                url: url,
                data: {id: @Model.IdInventario},
                success: function (data) {
                    $('#partialImagenes').html(data);
                },
                error: function (err, scnd) {
                    cargarAlert('@SharedLocalizer["errorGeneral"]');
                    console.log(err.statusText);
                }
            });
        }



        function guardarRelacionIB(id) {

            var url = "@Url.Action("CrearInventarioBodega", "Inventario", new { id = "__id__" })";

            url = url.replace("__id__", id);

            for (var i = 0; i < inventarioBodegaNuevas.length; i++) {
                inventarioBodegaNuevas[i].existenciaMedia = inventarioBodegaNuevas[i].existenciaMedia.toString().replace(".", ",");
                inventarioBodegaNuevas[i].existenciaMinima = inventarioBodegaNuevas[i].existenciaMinima.toString().replace(".", ",");
                inventarioBodegaNuevas[i].existenciaMaxima = inventarioBodegaNuevas[i].existenciaMaxima.toString().replace(".", ",");
            }

            $.ajax({
                type: "post",
                headers: {
                    "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                },
                url: url,
                data: { inventarioBodega: inventarioBodegaNuevas},
                success: function (data) {

                    window.location.href = '@Url.Action("ListarInventario", "Inventario")';
                },
                error: function (err, scnd) {

                    cargarAlert('@SharedLocalizer["errorGeneral"]');
                    console.log(err.statusText);
                }
            });
        }

        function setSubFamilia(id, idSub) {
            $('#subFamilias option').remove();
            for (var i = 0; i < familias.length; i++) {
                subFamilia = familias[i].inverseIdFamiliaNavigation;
                if (familias[i].id === parseInt(id))
                    for (var j = 0; j < subFamilia.length; j++) {
                        var o = new Option(subFamilia[j].descripcion, subFamilia[j].id);
                        $("#subFamilias").append(o);
                        if (subFamilia[j].id === idSub)
                            $(o).attr('selected', true);
                    }
            }
        }


    function setSubFamiliaOnline(id, idSub) {
            $('#subFamiliasOnline option').remove();
            for (var i = 0; i < familiasOnline.length; i++) {
                subFamiliaOnline = familiasOnline[i].inverseIdFamiliaNavigation;
                if (familiasOnline[i].id === parseInt(id))
                    for (var j = 0; j < subFamiliaOnline.length; j++) {
                        var o = new Option(subFamiliaOnline[j].descripcion, subFamiliaOnline[j].id);
                        $("#subFamiliasOnline").append(o);
                        if (subFamiliaOnline[j].id === idSub)
                            $(o).attr('selected', true);
                    }
            }
        }

    function setFamilias(data) {

        var familiaLocal = data.familia;

        if (familiaLocal.idFamilia === null)
            getFamilias(familiaLocal.id, 0);
        else
            getFamilias(familiaLocal.idFamilia, familiaLocal.id);

        $('#modalFamilia').modal('hide');

    }

    function setFamiliasOnline(data) {

        var familiaLocal = data.familia;

        if (familiaLocal.idFamilia === null)
            getFamiliasOnline(familiaLocal.id, 0);
        else
            getFamiliasOnline(familiaLocal.idFamilia, familiaLocal.id);

        $('#modalFamiliaOnline').modal('hide');

    }


    function eliminarFamiliaPadre(id) {
        for (var i = 0; i < familias.length; i++) {
            if (id === familias[i].id)
                lineas.splice(i, 1);
        }

    }

    function eliminarSubFamilia(id, idSub) {
        for (var i = 0; i < familias.length; i++) {
            if (id === familias[i].id)
                for (var i = 0; i < familias[i].inverseIdFamiliaNavigation.length; i++) {
                    lineas.splice(j, 1);
                }
        }
    }

    function formIsValid() {
        var array = $('#formInventario').serializeArray();
        var flag = true;


        if (parseFloat(array[1].value) <= 0 || array[1].value === ""){
            $('#presentacionValid').attr('hidden', false);
            flag = false;
        } else
            $('#presentacionValid').attr('hidden', true);

        if (array[3].value.replace(/ /g, "") === "")
            array[3].value = 0;
        if (array[11].value === "")
            array[11].value = 0;
        if (array[13].value === "")
            array[13].value = 0;
        if (array[16].value === "")
            array[16].value = 0;
        if (array[19].value === "")
            array[19].value = 0;
        if (array[14].value === "")
            array[14].value = 0;
        if (array[15].value === "")
            array[15].value = 0;
        if (array[17].value === "")
            array[17].value = 0;
        if (array[18].value === "")
            array[18].value = 0;
        if (array[20].value === "")
            array[20].value = 0;
        if (array[21].value === "")
            array[21].value = 0;
        if (array[4].value.replace(/ /g, "") === "") {
            $('#codigoValid').attr('hidden', false);
            flag = false;
        } else
            $('#codigoValid').attr('hidden', true);

        if (array[7].value.replace(/ /g, "") === "") {
            $('#descripcionValid').attr('hidden', false);
            flag = false;
        } else
            $('#descripcionValid').attr('hidden', true);

        if (inventarioBodega.length <= 0)
            $('#itemSinBodega').attr('hidden', false);//cargarAlert("");
        else
            $('#itemSinBodega').attr('hidden', true);

        return flag;
    }

    function cargarDatos(data) {

        //console.log(data);

        $('.filasCargadas').remove();

        contadorFila = 0;

        for (var i = 0; i < data.length; i++) {
            contadorFila++;
            var body = '<tr class="filasCargadas" id="fila' + contadorFila + '"><td>' + data[i].idBodegaNavigation.nombre + '</td>'
                + '<td>' + data[i].existenciaMinima + '</td>'
                + '<td>' + data[i].existenciaMedia + ' </td>'
                + '<td>' + data[i].existenciaMaxima + '</td>'
                + '<td>' + data[i].existenciaBodega + '</td>'
                + '<td style="text-align: right">' + formatMoneda(data[i].costoPromedioBodega) + '</td>'
                + '<td style="text-align: right">' + formatMoneda(data[i].saldoBodega) + '</td>'
                + '<td><button class="btn btn-link" value="' + contadorFila + '" onclick="eliminarBodegaInventario( value, ' + data[i].id + ')" ><i class="fas fa-trash"></i></button></td></tr>';

            $('.bodegaInventarioForm').before(body);
        }
    }

    function formatMoneda(value) {
        $('#formatterMoneda').val(value);

        return $('#formatterMoneda').val();
    }

    function eliminarBodegaInventario(fila, idRelacion) {

        bootbox.confirm("@SharedLocalizer["confirmEliminar"]", function (result) {

            if (result) {
            var flag = false;

            for (var i = 0; i < inventarioBodega.length; i++) {
                if (inventarioBodega[i].id == idRelacion)
                    if (inventarioBodega[i].existenciaBodega > 0)
                        flag = true;
            }
                if (inventarioBodega.length > 1) {

                if (idRelacion != 0) {
                    var url = "@Url.Action("EliminarInventarioBodega", "Inventario", new { id = "__id__" })";
                    url = url.replace("__id__", idRelacion);

                    if (!flag)
                        $.ajax({
                            type: "get",
                            headers: {
                                "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                            },
                            url: url,
                            //data: { id: idRelacion },
                            success: function (data) {
                                eliminarLocal(fila);
                            },
                            error: function (err, scnd) {
                                console.log(err.statusText);
                                cargarAlert('@SharedLocalizer["errorGeneral"]');
                            }
                        });
                    else
                        cargarAlert("@SharedLocalizer["eliminarInventario"]");
                }
                else {
                    eliminarLocal(fila);
                }
            }
            else {
                cargarAlert("@SharedLocalizer["bodegaAsignada"]");
            }
        }

        });
    }

    function eliminarLocal(id) {

        inventarioBodega.splice(id - 1, 1);
        cargarDatos(inventarioBodega);

        }

    function cambiarValor() {
        $("#txtDescripcion").keyup(function () {
            var value = $(this).val();
            $("#txtNombreCarrito").val(value);
            $("#txtAbreviacionFactura").val(value);
        });
    }

    function getCaracteristicas() {

            var url = '@Url.Action("_ListarCaracteristicas", "Inventario")';
            $.ajax({
                type: "get",
                headers: {
                    "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                },
                url: url,
                data: {id: @Model.IdInventario},
                success: function (data) {
                    $('#partialCaracteristicas').html(data);
                },
                error: function (err, scnd) {
                    cargarAlert('@SharedLocalizer["errorGeneral"]');
                    console.log(err.statusText);
                }
            });
        }





        function guardarCaracteristica() {
            //$('#frmComentario').serializeArray()
            var comentario = $('#txtCaracteriscas').val();

            $.ajax({
                type: "post",
                headers: {
                    "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                },
                url: '@Url.Action("CargarCaracteristicasInventario", new {id = Model.IdInventario })',
                data: {
                    model: comentario
                },
                success: function (data) {
                    $('#modalCaracteristicas').modal('hide');
                    getCaracteristicas();

                },
                error: function (err, scnd) {
                    @*cargarAlert("@SharedLocalizer("errorGeneral")");*@
                    console.log(err.statusText);
                }
            });
        }
</script>

