@model AltivaWebApp.ViewModels.MensajeViewModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@functions{
    public string GetAntiXsrfRequestToken()
    {
        return Xsrf.GetAndStoreTokens(Context).RequestToken;
    }
}

<div class="row">
    
    <div class="col-md-6">
        <br />
        <form id="frmComentario">
            
            <div class="form-group">
                <label asp-for="mensaje" class="control-label">Comentario:</label>
                <textarea id="txtMensaje" asp-for="mensaje" class="form-control" rows="4"> </textarea>
                <span hidden data-translate="comentarioValid" id="comentarioValid" class="text-danger">Comentario no puede ir vacío.</span>
            </div>
            <div class="form-group">
                <span data-translate="cargaArchivos" class="input-group-text" id="inputGroup-sizing-sm">Adjuntar Archivos</span>
                <input type="file" asp-for="Files" class="form-control" multiple="multiple" id="fileUpload">
                <span hidden class="text-danger" data-translate="tamanoArchivoValid" id="tamanoArchivos">El tamaño máximo del archivo es de 25MB.</span>
                <span hidden data-translate="cantidadArchivosValid" id="cantidadArchivos" class="text-danger">No puede agregar más de 5 archivos.</span>
            </div>
            <div class="form-group" hidden>
                <label asp-for="tipoMensaje" class="control-label"></label>
                <input id="txtTipoMensaje" asp-for="tipoMensaje" class="form-control" />
            </div>
            <div class="form-group" hidden>
                <label asp-for="tipoReferencia" class="control-label"></label>
                <input id="txtTipoReferencia" asp-for="tipoReferencia" class="form-control" />
            </div>
            <div class="form-group" hidden>
                <label asp-for="id" class="control-label"></label>
                <input id="txtId" asp-for="id" class="form-control" />
            </div>
        </form>
        <div class="form-group">
            <button class="btn btn-primary" onclick="guardarComentario()" id="btnGuardarComentario">Guardar <i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="col-md-6">
        <div id="listaComentarios">
            <div id="contenido">

            </div>
        </div>
    </div>
</div>



<script>
    var model = {
            idReferencia: 0,
            tipoReferencia: ''
        };

    $(document).ready(function () {
     
        model.idReferencia= @Model.id;
        model.tipoReferencia = '@Model.tipoReferencia';

        GetComentarios(model);

    });



    function guardarComentario() {
        //$('#frmComentario').serialize()
        
        var formData = new FormData();
        var file = [];
        var files = $('#fileUpload')[0].files;

        for (var i = 0; i < files.length; i++) {           
            formData.append("files", files[i]);
        }
       

        formData.append('mensaje', $('#txtMensaje').val());
        formData.append('tipoMensaje', $('#txtTipoMensaje').val());
        formData.append('tipoReferencia', $('#txtTipoReferencia').val());
        formData.append('id', $('#txtId').val());
        console.log($('#txtMensaje').val());
        if ($('#txtMensaje').val() != "")
            $.ajax({
                type: "post",
                headers: {
                    "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                },
                url: '../../Mensajes/Crear-ComentrioPost',
                dataType: 'json',
                contentType: false,
                processData: false,
                data: formData,
                success: function (data) {
                    $('#txtMensaje').val("");
                    $('#fileUpload').val('');
                    GetComentarios(model);
                    $('#comentarioValid').attr('hidden', true);
                    $('#tamanoArchivos').attr('hidden', true);
                    $('#cantidadArchivos').attr('hidden', true);

                },
                error: function (err, scnd) {
                    alert("Lo sentimos, tuvimos un problema al procesar tu solicitud");
                    console.log(err.statusText);
                }
            });
        else
            $('#comentarioValid').attr('hidden', false);
    }

    $('#fileUpload').bind('change', function () {

        var e = 0;
        for (var i = 0; i < this.files.length; i++) {

            e = + this.files[i].size;
            if (e > 250000) {
                $('#tamanoArchivos').attr('hidden', false);
                $(this).val('');
                break;
            }
        }

        if (this.files.length > 5) {
            $(this).attr("value", "");
            $('#cantidadArchivos').attr('hidden', false);
            $(this).val('');
        }
    });

    function GetComentarios(model) {
         $.ajax({
             type: "POST",
             headers: {
                "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
             },
             url: '@Url.Action("ListarComentarios", "Mensajes")',
             data: model,
             success: function (data) {
                 $('#contenido').remove();
                 $('#listaComentarios').html('<div id=contenido></div>');  
                 $('#contenido').html(data);   
                                      
             },
             error: function (err, scnd) {

                alert("Lo sentimos, tuvimos un problema al procesar tu solicitud.");
                console.log(err.statusText);

             }           

         });
    }
</script>
